# Session: 2026-01-28 (Linux)

## Context
- **Repo**: alchmy
- **Branches worked on**:
  - `feature/bbocax-preferred-exch`
  - `feature/bbocax-additional-split-services`
  - `feature/bbocax-equities`
  - `feature/bbocax-futures-ext`
  - `feature/enable-bbocax-prod06`

## Goals
- [x] Review yesterday's session and continue bbocax mapping
- [x] Get bbocax equities command
- [x] Get bbocax futures_extended command
- [x] Work on bbocax_back_office_preferred_exch branch
- [x] Clean up bbocax-additional-split-services branch
- [x] Add currency and supplemental to playbooks
- [x] Fix service naming convention (underscore) across all branches
- [x] Enable bbocax_back_office_futures in prod06 playbook
- [x] Add BBOCAX documentation to dataset-operations-manual.md
- [x] Investigate FILE_PATTERN not working on prod services
- [x] Document bbocax platinum output paths
- [x] Investigate SQLite disk I/O error on street_events service

## Work Log

### Session Context Review

Reviewed yesterday's session (2026-01-27) and bbocax notes:
- data-alchemy on `feature/bbocax-corporate-actions` (5 commits ahead of dev)
- Multiple bbocax branches available for different datasets

---

### feature/bbocax-preferred-exch Branch Work

#### Branch Setup
```bash
git checkout feature/bbocax-preferred-exch
git pull
git fetch origin dev && git merge origin/dev
```

#### Cherry-picked Service Files
From `feature/bbocax-additional-split-services`:
- Only picked `back_office_preferred_exch` service files
- Renamed: `bbocax-back_office_preferred_exch` → `bbocax_back_office_preferred_exch` (underscore convention)

#### Grabber Maps Verified
| Grabber Map | Compression | Files |
|-------------|-------------|-------|
| `preferred_exch_1_0.json` | `gzip_no_ext` | CSV, dif, out, px, px.hpc |
| `preferred_exch_parquet_1_0.json` | `none` | parquet |

**Production files verified** at `/sf/data/bloomberg/back_office_preferred_exch/1.0/raw/2026/20260126/`:
- All files are gzip compressed (without .gz extension) except parquet
- 104 total files per day

#### Playbook Updates
**Staging** (`deploy-data-alchemy-staging.yml`): Added active (not commented)
**Prod06** (`deploy-data-alchemy-prod06.yml`): Added as commented

---

### feature/bbocax-additional-split-services Branch Cleanup

#### Removed Duplicate Services
Services now on dedicated branches were removed:
- `back_office_equities` → on `feature/bbocax-equities`
- `back_office_futures_extended` → on `feature/bbocax-futures-ext`
- `back_office_preferred_exch` → on `feature/bbocax-preferred-exch`
- `back_office_futures` → already on dev
- `corporate_actions` → already on dev
- `back_office_preferred_exch_corporate_actions` → already on dev
- `bbocax_cwiq_pipe` → already on dev

#### Remaining Services (unique to this branch)
- `back_office_currency`
- `back_office_supplemental`

#### Playbook Updates
**Staging**: Added active (not commented)
**Prod06**: Added as commented

---

### Service Naming Convention Fix

**Convention**: `bbocax_back_office_*` (underscore between bbocax and dataset name)

Fixed across all branches:

| Branch | Before | After |
|--------|--------|-------|
| `feature/bbocax-additional-split-services` | `bbocax-back_office_currency` | `bbocax_back_office_currency` |
| `feature/bbocax-additional-split-services` | `bbocax-back_office_supplemental` | `bbocax_back_office_supplemental` |
| `feature/bbocax-equities` | `bbocax-back_office_equities` | `bbocax_back_office_equities` |
| `feature/bbocax-futures-ext` | `bbocax-back_office_futures_extended` | `bbocax_back_office_futures_extended` |
| `feature/bbocax-preferred-exch` | Already correct | `bbocax_back_office_preferred_exch` |

Playbooks also updated on each branch.

---

### BBOCAX Commands Reference

#### 1. Back Office Futures
```bash
uv run python -m data_alchemy.main \
  --vendor bloomberg \
  --dataset bbocax_cwiq_pipe \
  --version 1.0 \
  --backfill 1650 \
  --ignore-db \
  --db-name '{vendor}--{ds}--back_office_futures' \
  --file-pattern '(share|nonShare)FuturesBulk'
```

#### 2. Corporate Actions
```bash
uv run python -m data_alchemy.main \
  --vendor bloomberg \
  --dataset bbocax_cwiq_pipe \
  --version 1.0 \
  --backfill 1650 \
  --ignore-db \
  --db-name '{vendor}--{ds}--corporate_actions' \
  --file-pattern '((equity|pfdExch|effDt|premarket).+CorporateActions|equity_(asia1|asia2|euro|lamr|namr)\.cax|pfd_exch_(asia|euro|lamr|namr)\.cax)'
```

#### 3. Back Office Equities
```bash
uv run python -m data_alchemy.main \
  --vendor bloomberg \
  --dataset bbocax_cwiq_pipe \
  --version 1.0 \
  --backfill 1650 \
  --ignore-db \
  --db-name '{vendor}--{ds}--back_office_equities' \
  --file-pattern '(equity(Asia1|Asia2|Euro|Lamr|Namr|MifidEuro)(?!.*(CorporateActions|\.cax))|equity_(asia1|asia2|euro|lamr|namr|mifid_euro)(?!\.cax))'
```

#### 4. Back Office Futures Extended
```bash
uv run python -m data_alchemy.main \
  --vendor bloomberg \
  --dataset bbocax_cwiq_pipe \
  --version 1.0 \
  --backfill 1650 \
  --ignore-db \
  --db-name '{vendor}--{ds}--back_office_futures_extended' \
  --file-pattern '(share|nonShare)FuturesExtended'
```

#### 5. Back Office Preferred Exch
```bash
uv run python -m data_alchemy.main \
  --vendor bloomberg \
  --dataset bbocax_cwiq_pipe \
  --version 1.0 \
  --backfill 1650 \
  --ignore-db \
  --db-name '{vendor}--{ds}--back_office_preferred_exch' \
  --file-pattern '(pfdExch(Asia|Euro|Lamr|Namr)(?!.*(CorporateActions|\.cax))|pfd_exch_(asia|euro|lamr|namr)(?!\.cax))'
```

#### 6. Back Office Currency
```bash
uv run python -m data_alchemy.main \
  --vendor bloomberg \
  --dataset bbocax_cwiq_pipe \
  --version 1.0 \
  --backfill 1650 \
  --ignore-db \
  --db-name '{vendor}--{ds}--back_office_currency' \
  --file-pattern '[Cc]urncy'
```

#### 7. Back Office Supplemental
```bash
uv run python -m data_alchemy.main \
  --vendor bloomberg \
  --dataset bbocax_cwiq_pipe \
  --version 1.0 \
  --backfill 1650 \
  --ignore-db \
  --db-name '{vendor}--{ds}--back_office_supplemental' \
  --file-pattern '(condition_code|fields\.|lookup\.)'
```

---

## Service File Branches Reference

| Dataset | Branch | Service File |
|---------|--------|--------------|
| back_office_equities | `feature/bbocax-equities` | `bbocax_back_office_equities.service` |
| back_office_futures_extended | `feature/bbocax-futures-ext` | `bbocax_back_office_futures_extended.service` |
| back_office_preferred_exch | `feature/bbocax-preferred-exch` | `bbocax_back_office_preferred_exch.service` |
| back_office_currency | `feature/bbocax-additional-split-services` | `bbocax_back_office_currency.service` |
| back_office_supplemental | `feature/bbocax-additional-split-services` | `bbocax_back_office_supplemental.service` |
| corporate_actions | `feature/bbocax-corporate-actions` | `bbocax-corporate_actions.service` |

---

## Glob vs Regex Reference

| Shell | Syntax |
|-------|--------|
| Bash glob | `{dif,out}` |
| Regex | `(dif\|out)` |

**Example:**
```bash
# Correct (bash brace expansion)
file /sf/data/bloomberg/back_office_preferred_exch/1.0/raw/2026/20260126/pfd_exch_namr_cins_bbid.{dif,out}

# Wrong (regex syntax in bash)
file /sf/data/bloomberg/back_office_preferred_exch/1.0/raw/2026/20260126/pfd_exch_namr_cins_bbid.(dif|out)
```

---

### feature/enable-bbocax-prod06 Branch

**MR:** https://git.codewilling.com/data/cwiq-pipe/data-alchemy/-/merge_requests/492

#### Changes Made
1. Created branch from dev to enable bbocax split services in prod06
2. Renamed service files: `bbocax-back_office_futures` → `bbocax_back_office_futures`
3. Enabled `bbocax_back_office_futures` in prod06 playbook
4. Removed old `bbocax_cwiq_pipe` entries from playbook (will turn off manually)
5. Added BBOCAX section to `docs/operations/dataset-operations-manual.md`:
   - Split services table with full service names and FILE_PATTERN
   - Compression settings (gzip_no_ext vs none for parquet)
   - Uncaptured file patterns (13 categories with examples)

#### Uncaptured File Patterns Documented
| Category | Example |
|----------|---------|
| Calendar | `calendar.dif.gz.enc` |
| Corp Pfd | `corp_pfd_asia.dif.gz.enc` |
| Credit Risk | `creditRiskV3.csv.gz` |
| Economist Estimates | `economistEstimatesChanges.out.gz` |
| Funds Sec13f2 | `fundsSec13f2V2.csv.gz` |
| Global FIGI Lookup | `globalFigiLookupSnapshot1.csv.gz` |
| Global Sanctions | `globalEquityOptionsSanctionsV2.csv.gz` |
| Government | `govt_national_asia.dif.gz.enc` |
| Legal Entity NACE | `legalEntityNace20.csv.gz` |
| NAICS | `northAmericanIndustryClassificationSystem.csv.gz` |
| Preferred Sec13f2 | `preferredSec13f2V2.csv.gz` |
| Tick Size Table | `tickSizeTable0230.csv.gz` |
| Warrant Sec13f2 | `warrantSec13f2V2.csv.gz` |

---

## BBOCAX Coverage Summary

### 8 Split Services (Captured)
| # | Service | FILE_PATTERN |
|---|---------|--------------|
| 1 | back_office_futures | `(share\|nonShare)FuturesBulk` |
| 2 | corporate_actions | `((equity\|pfdExch\|effDt\|premarket).+CorporateActions\|*.cax)` |
| 3 | back_office_preferred_exch_corporate_actions | `(pfdExch*CorporateActions\|pfd_exch_*.cax)` |
| 4 | back_office_equities | `equity*(?!.*CorporateActions)` |
| 5 | back_office_futures_extended | `(share\|nonShare)FuturesExtended` |
| 6 | back_office_preferred_exch | `pfdExch*(?!.*CorporateActions)` |
| 7 | back_office_currency | `[Cc]urncy` |
| 8 | back_office_supplemental | `(condition_code\|fields\.\|lookup\.)` |

### 13 Uncaptured Categories
Calendar, Corp Pfd, Credit Risk, Economist Estimates, Funds Sec13f2, Global FIGI Lookup, Global Sanctions, Government, Legal Entity NACE, NAICS, Preferred Sec13f2, Tick Size Table, Warrant Sec13f2

### File Extensions
- **gzip_no_ext**: `.csv`, `.dif`, `.dlt`, `.out`, `.px`, `.px.hpc`, `.rpx`, `.cax`
- **none**: `.parquet`

---

### FILE_PATTERN Issue on Production

**Problem**: Services processing wrong files - pattern not being applied

**Symptoms**:
- `bbo_corporate_actions` processing `equityOptionsLamr1.dif.gz.enc`, `nonShareFuturesExtendedOpen1Asia.csv.gz` instead of `*CorporateActions*` and `*.cax`
- `back_office_preferred_exch` processing `equityIndexOptions*`, `nonShareFutures*`, `equityWarrant*` instead of `pfdExch*`

**Root Cause**: Shell script `data-alchemy-service-prod-dataset.sh` doesn't quote FILE_PATTERN:
```bash
# BUG: Missing quotes around ${_FILE_PATTERN}
OPTIONAL_ARGS="${OPTIONAL_ARGS} --file-pattern ${_FILE_PATTERN}"
```

Patterns with `|`, `()` get interpreted by bash.

**Fix Options**:
1. Quote in shell script: `--file-pattern '${_FILE_PATTERN}'`
2. Change service file patterns to avoid special characters

---

### BBOCAX Platinum Output Paths

Full list for today (20260128):

```
/sf/data/bloomberg/corporate_actions/1.0/raw/2026/20260128/
/sf/data/bloomberg/corporate_actions/2.0/raw/2026/20260128/
/sf/data/bloomberg/back_office_currency/1.0/raw/2026/20260128/
/sf/data/bloomberg/back_office_futures/2.0/raw/non_share_futures/2026/20260128/
/sf/data/bloomberg/back_office_futures/2.0/raw/share_futures/2026/20260128/
/sf/data/bloomberg/back_office_preferred_exch/1.0/raw/2026/20260128/
/sf/data/bloomberg/back_office_preferred_exch_corporate_actions/1.0/raw/2026/20260128/
/sf/data/bloomberg/back_office_preferred_exch_corporate_actions/2.0/raw/2026/20260128/
/sf/data/bloomberg/back_office_supplemental/1.0/raw/2026/20260128/
```

**Note**: Local path is `/sf/proj/data_alchemy/assets/cdp_out/bloomberg/...` which maps to `/sf/data/bloomberg/...` on prod.

---

### SQLite Disk I/O Error

**Error**:
```
ERROR | [lseg_refinitiv/street_events_cwiq_pipe] Silver - OperationalError - (sqlite3.OperationalError) disk I/O error
```

**File**: `/sf/data/lseg_refinitiv/street_events_cwiq_pipe/1.0/silver/2026/01/28/lseg_refinitiv--street_events_cwiq_pipe.sqlite`

**Cause**: SQLite on NFS mount (`/sf/data`) can cause locking issues

**Solutions**:
1. Move DB to local disk (e.g., `/home/svc_dat_alchemy/`)
2. Restart service to clear stale locks
3. Check NFS server health

**Diagnostic Commands**:
```bash
# Check if NFS
mount | grep "/sf/data"

# Check for stale locks
lsof /sf/data/lseg_refinitiv/street_events_cwiq_pipe/1.0/silver/2026/01/28/*.sqlite

# Check NFS mount options
mount | grep nfs
```

---

## Notes

- Folder date format is `YYYYMMDD` not `YYYY/MM/DD`
- `back_office_futures/2.0/raw/` has subdirs: `non_share_futures/`, `share_futures/`
- SQLite + NFS = potential disk I/O errors

---

## Next Steps
- [ ] Fix FILE_PATTERN quoting in shell scripts
- [ ] Redeploy services to prod
- [ ] Validate services only process correct files
- [ ] Consider moving SQLite DBs to local disk
- [ ] Run preferred_exch backfill command and validate
- [ ] Run currency backfill command and validate
- [ ] Run supplemental backfill command and validate
- [ ] Run DQ validation for all datasets
- [ ] Merge feature branches to dev
- [ ] Merge feature/enable-bbocax-prod06 to dev
