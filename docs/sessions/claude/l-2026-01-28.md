# Session: 2026-01-28 (Linux)

## Context
- **Repo**: alchmy
- **Branches worked on**:
  - `feature/bbocax-preferred-exch`
  - `feature/bbocax-additional-split-services`

## Goals
- [x] Review yesterday's session and continue bbocax mapping
- [x] Get bbocax equities command
- [x] Get bbocax futures_extended command
- [x] Work on bbocax_back_office_preferred_exch branch
- [x] Clean up bbocax-additional-split-services branch
- [x] Add currency and supplemental to playbooks

## Work Log

### Session Context Review

Reviewed yesterday's session (2026-01-27) and bbocax notes:
- data-alchemy on `feature/bbocax-corporate-actions` (5 commits ahead of dev)
- Multiple bbocax branches available for different datasets

---

### feature/bbocax-preferred-exch Branch Work

#### Branch Setup
```bash
git checkout feature/bbocax-preferred-exch
git pull
git fetch origin dev && git merge origin/dev
```

#### Cherry-picked Service Files
From `feature/bbocax-additional-split-services`:
- Only picked `back_office_preferred_exch` service files
- Renamed: `bbocax-back_office_preferred_exch` → `bbocax_back_office_preferred_exch` (underscore convention)

#### Grabber Maps Verified
| Grabber Map | Compression | Files |
|-------------|-------------|-------|
| `preferred_exch_1_0.json` | `gzip_no_ext` | CSV, dif, out, px, px.hpc |
| `preferred_exch_parquet_1_0.json` | `none` | parquet |

**Production files verified** at `/sf/data/bloomberg/back_office_preferred_exch/1.0/raw/2026/20260126/`:
- All files are gzip compressed (without .gz extension) except parquet
- 104 total files per day

#### Playbook Updates
**Staging** (`deploy-data-alchemy-staging.yml`): Added active (not commented)
**Prod06** (`deploy-data-alchemy-prod06.yml`): Added as commented

---

### feature/bbocax-additional-split-services Branch Cleanup

#### Removed Duplicate Services
Services now on dedicated branches were removed:
- `back_office_equities` → on `feature/bbocax-equities`
- `back_office_futures_extended` → on `feature/bbocax-futures-ext`
- `back_office_preferred_exch` → on `feature/bbocax-preferred-exch`
- `back_office_futures` → already on dev
- `corporate_actions` → already on dev
- `back_office_preferred_exch_corporate_actions` → already on dev
- `bbocax_cwiq_pipe` → already on dev

#### Remaining Services (unique to this branch)
- `back_office_currency`
- `back_office_supplemental`

#### Playbook Updates
**Staging**: Added active (not commented)
**Prod06**: Added as commented

---

### BBOCAX Commands Reference

#### 1. Corporate Actions
```bash
uv run python -m data_alchemy.main \
  --vendor bloomberg \
  --dataset bbocax_cwiq_pipe \
  --version 1.0 \
  --backfill 1650 \
  --ignore-db \
  --db-name '{vendor}--{ds}--corporate_actions' \
  --file-pattern '((equity|pfdExch|effDt|premarket).+CorporateActions|equity_(asia1|asia2|euro|lamr|namr)\.cax|pfd_exch_(asia|euro|lamr|namr)\.cax)'
```

#### 2. Back Office Equities
```bash
uv run python -m data_alchemy.main \
  --vendor bloomberg \
  --dataset bbocax_cwiq_pipe \
  --version 1.0 \
  --backfill 1650 \
  --ignore-db \
  --db-name '{vendor}--{ds}--back_office_equities' \
  --file-pattern '(equity(Asia1|Asia2|Euro|Lamr|Namr|MifidEuro)(?!.*(CorporateActions|\.cax))|equity_(asia1|asia2|euro|lamr|namr|mifid_euro)(?!\.cax))'
```

#### 3. Back Office Futures Extended
```bash
uv run python -m data_alchemy.main \
  --vendor bloomberg \
  --dataset bbocax_cwiq_pipe \
  --version 1.0 \
  --backfill 1650 \
  --ignore-db \
  --db-name '{vendor}--{ds}--back_office_futures_extended' \
  --file-pattern '(share|nonShare)FuturesExtended'
```

#### 4. Back Office Preferred Exch
```bash
uv run python -m data_alchemy.main \
  --vendor bloomberg \
  --dataset bbocax_cwiq_pipe \
  --version 1.0 \
  --backfill 1650 \
  --ignore-db \
  --db-name '{vendor}--{ds}--back_office_preferred_exch' \
  --file-pattern '(pfdExch(Asia|Euro|Lamr|Namr)(?!.*(CorporateActions|\.cax))|pfd_exch_(asia|euro|lamr|namr)(?!\.cax))'
```

#### 5. Back Office Currency
```bash
uv run python -m data_alchemy.main \
  --vendor bloomberg \
  --dataset bbocax_cwiq_pipe \
  --version 1.0 \
  --backfill 1650 \
  --ignore-db \
  --db-name '{vendor}--{ds}--back_office_currency' \
  --file-pattern '[Cc]urncy'
```

#### 6. Back Office Supplemental
```bash
uv run python -m data_alchemy.main \
  --vendor bloomberg \
  --dataset bbocax_cwiq_pipe \
  --version 1.0 \
  --backfill 1650 \
  --ignore-db \
  --db-name '{vendor}--{ds}--back_office_supplemental' \
  --file-pattern '(condition_code|fields\.|lookup\.)'
```

---

## Service File Branches Reference

| Dataset | Branch | Service File |
|---------|--------|--------------|
| back_office_equities | `feature/bbocax-equities` | `bbocax-back_office_equities.service` |
| back_office_futures_extended | `feature/bbocax-futures-ext` | `bbocax-back_office_futures_extended.service` |
| back_office_preferred_exch | `feature/bbocax-preferred-exch` | `bbocax_back_office_preferred_exch.service` |
| back_office_currency | `feature/bbocax-additional-split-services` | `bbocax-back_office_currency.service` |
| back_office_supplemental | `feature/bbocax-additional-split-services` | `bbocax-back_office_supplemental.service` |
| corporate_actions | `feature/bbocax-corporate-actions` | `bbocax-corporate_actions.service` |

---

## Glob vs Regex Reference

| Shell | Syntax |
|-------|--------|
| Bash glob | `{dif,out}` |
| Regex | `(dif\|out)` |

**Example:**
```bash
# Correct (bash brace expansion)
file /sf/data/bloomberg/back_office_preferred_exch/1.0/raw/2026/20260126/pfd_exch_namr_cins_bbid.{dif,out}

# Wrong (regex syntax in bash)
file /sf/data/bloomberg/back_office_preferred_exch/1.0/raw/2026/20260126/pfd_exch_namr_cins_bbid.(dif|out)
```

---

## Next Steps
- [ ] Run preferred_exch backfill command and validate
- [ ] Run currency backfill command and validate
- [ ] Run supplemental backfill command and validate
- [ ] Run DQ validation for all datasets
- [ ] Merge feature branches to dev
