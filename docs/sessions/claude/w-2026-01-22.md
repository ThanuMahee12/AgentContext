# Session: 2026-01-22 (Windows)

## Summary
- bbocax grabber map verification
- Date extraction analysis: filename suffix vs mtime
- Equities mapping review
- PathSeek project setup (branch strategy, CI/CD workflows)
- MkDocs documentation setup
- PR conflict check - all clean
- **ACL Checker refactor** - smart glob patterns, nested scan behavior

---

## bbocax Grabber Maps - Date Extraction

All bbocax grabber maps use **filename timestamp**, NOT mtime.

### Two-Pattern Strategy

Each grabber map has two patterns per file type:

| Priority | Source | Example |
|----------|--------|---------|
| **Primary** | Filename date suffix | `curncyAsia1.parquet.20251214` → extracts `20251214` |
| **Fallback** | Directory path (mtime-based) | `silver/2025/12/14/work/...` |

### Grabber Maps Verified

| Grabber Map | Date Source | Branch |
|-------------|-------------|--------|
| `backoffice_1_0` | Filename suffix / Directory | dev |
| `backoffice_cax_1_0` | Filename suffix / Directory | dev |
| `backoffice_cax_2_0` | Filename suffix / Directory | dev |
| `backoffice_parquet_2_0` | Filename suffix / Directory | dev |
| `corporate_actions_1_0` | Filename suffix / Directory | dev |
| `corporate_actions_cax_1_0` | Filename suffix / Directory | dev |
| `corporate_actions_cax_2_0` | Filename suffix / Directory | dev |
| `futures_2_0` | Filename suffix / Directory | dev |
| `currency_1_0` | Filename suffix / Directory | feature/bbocax-currency |
| `currency_parquet_1_0` | Filename suffix / Directory | feature/bbocax-currency |
| `equities_1_0` | Filename suffix / Directory | feature/bbocax-equities |
| `equities_parquet_1_0` | Filename suffix / Directory | feature/bbocax-equities |

---

## Pipeline Date Flow

```
RAW (cwiq_pipe)
└── env0/curncyAsia1.parquet.20251214        ← Bloomberg provides date suffix

BRONZE (mtime-based)
└── 2025/12/14/020609-0500--curncyAsia1.parquet.20251214
    ↑ directory    ↑ time prefix  ↑ original filename preserved

SILVER
└── 2025/12/14/work/020609-0500--curncyAsia1.parquet.20251214

GOLD (grabber map extracts date)
└── back_office_currency/1.0/raw/2025/20251214/curncyAsia1.parquet
                              ↑ from filename    ↑ suffix stripped
```

### Date Sources

| Layer | Date Source | Used For |
|-------|-------------|----------|
| Bronze | mtime | Directory structure (`YYYY/MM/DD/`), time prefix (`HHMMSS--`) |
| Silver | Preserved | Same as bronze |
| Gold | Filename suffix (primary) | Output directory (`YYYY/YYYYMMDD/`) |
| Gold | Directory path (fallback) | When no filename suffix |

---

## Grabber Map Pattern Examples

### With Filename Date Suffix (Primary)
```regex
\.parquet\.(?P<y>\d{4})(?P<m>\d{2})(?P<d>\d{2})$
```
Matches: `curncyAsia1.parquet.20251214`

### Without Date Suffix (Fallback)
```regex
silver/(?P<y>\d{4})/(?P<m>\d{2})/(?P<d>\d{2})/work/...
```
Uses directory date from mtime

---

## Validation Paths (Confirm No Date Suffix in Output)

- Currency: `/bloomberg/back_office_currency/1.0/raw/{YYYY}/{YYYYMMDD}/curncyAsia1.csv`
- Futures: `/bloomberg/back_office_futures/2.0/raw/share_futures/{YYYY}/{YYYYMMDD}/shareFuturesBulkEuro.dif`

Output filenames do NOT have date suffix - suffix is stripped and used for directory only.

---

## Branches Checked

| Branch | Content |
|--------|---------|
| `dev` | All bbocax grabber maps except currency/equities |
| `feature/bbocax-currency` | Currency grabber maps (`currency_1_0`, `currency_parquet_1_0`) |
| `feature/bbocax-equities` | Equities grabber maps (`equities_1_0`, `equities_parquet_1_0`) |
| `feature/bbocax-mapping` | Older bbocax work (no grabber maps on this branch) |

---

## Key Files

- `data_alchemy/handlers/enrich_bronze_fp.py` - Uses mtime for bronze path
- `data_alchemy/handlers/handle_gold.py` - Applies grabber map transformations
- `resc/grabber_maps/bloomberg_bbocax_cwiq_pipe_*.json` - Grabber map definitions

---

## Equities Mapping (feature/bbocax-equities)

### Grabber Maps

| Map | File Types | Compression |
|-----|------------|-------------|
| `equities_1_0.json` | CSV, .out, .dif, .px, .rpx, .px.hpc | gzip_no_ext |
| `equities_parquet_1_0.json` | Parquet | none |

### File Patterns

| Grabber Map | Pattern | Example |
|-------------|---------|---------|
| `equities_1_0` | `equity(?!Options|Index)[^/]*\.csv` | `equityAsia1Pricing.csv` |
| `equities_1_0` | `equity_[^/]*\.(?:out|dif)` | `equity_asia1.out` |
| `equities_1_0` | `equity_[^/]*\.(?:px|rpx)` | `equity_asia1.px` |
| `equities_1_0` | `equity_[^/]*\.px\.hpc` | `equity_asia1.px.hpc` |
| `equities_parquet_1_0` | `equity(?!Options|Index)[^/]*\.parquet` | `equityAsia1.parquet` |

### Exclusions

Both maps exclude:
- `equityOptions*`
- `equityIndex*`

### Naming Conventions

| Type | Naming | Example |
|------|--------|---------|
| CSV/Parquet | CamelCase | `equityAsia1.csv`, `equityAsia1Pricing.parquet` |
| Binary (.out/.dif/.px) | Underscore | `equity_asia1.out`, `equity_asia1.dif` |

### Legacy CDP Coverage

| Pattern | Extensions | Covered |
|---------|------------|---------|
| `equity{Region}` | `.csv`, `.parquet`, `.dif`, `.out`, `.px`, `.px.hpc` | ✓ |
| `equity{Region}Cins` | `.csv`, `.parquet` | ✓ |
| `equity{Region}CinsDifferences` | `.csv` | ✓ |
| `equity{Region}Differences` | `.csv` | ✓ |
| `equity{Region}Pricing` | `.csv`, `.parquet` | ✓ |
| `equity{Region}RecapPricing` | `.csv`, `.parquet` | ✓ |
| `equity{Region}HistoricalPricing` | `.parquet` | ✓ |

---

## PathSeek Project Setup

Repository: https://github.com/ThanuMahee12/pathseek

### Branch Strategy

| Branch | Role | Protection |
|--------|------|------------|
| `main` | Stable release | Target for release PRs |
| `dev` | Default development | All feature branches → dev |

**Flow:** `feature/*` → PR → `dev` → Release PR → `main`

### Open PRs (All Clean)

| PR | Branch | Status |
|----|--------|--------|
| [#13](https://github.com/ThanuMahee12/pathseek/pull/13) | ci/docs-deploy | ✅ Mergeable |
| [#12](https://github.com/ThanuMahee12/pathseek/pull/12) | chore/git-config | ✅ Clean |
| [#10](https://github.com/ThanuMahee12/pathseek/pull/10) | docs/contributing | ✅ Clean |
| [#9](https://github.com/ThanuMahee12/pathseek/pull/9) | docs/mkdocs-setup | ✅ Clean |
| [#8](https://github.com/ThanuMahee12/pathseek/pull/8) | dev → main | ✅ Mergeable |

### GitHub Actions Workflows Created

| Workflow | Trigger | Action |
|----------|---------|--------|
| `release-pr.yml` | PR merged to dev | Creates draft PR: dev → main |
| `docs.yml` | PR merged to main | Deploys MkDocs to GitHub Pages |
| `sync-branches.yml` | Push to dev | Auto-merges dev into open PR branches |

### Documentation (MkDocs)

- `mkdocs.yml` - Material theme with mermaid support
- `docs/index.md` - Professional landing page with flowcharts
- `docs/usage.md` - CLI reference
- `docs/architecture.md` - Functional-first design docs
- `docs/contributing.md` - Contribution guide

### Git Config

- `.gitignore` - Added `*cache/` wildcard pattern
- `.gitattributes` - Line ending normalization

### CLAUDE.md Updates

Updated with:
- Branch strategy documentation
- CLI commands reference
- Project structure
- CI/CD workflow descriptions

---

## PR Conflict Check

All branches verified against dev - **no conflicts found**:
- `chore/git-config` - Clean merge
- `docs/contributing` - Clean merge
- `docs/mkdocs-setup` - Clean merge
- `ci/docs-deploy` - Mergeable

---

## ACL Checker Refactor (data-alchemy)

Branch: `feature/acl-checker-refactor`

### Smart Glob Pattern for Env Grouping

Updated `format_env_pattern()` to output usable patterns:

| Priority | Pattern | When |
|----------|---------|------|
| 1 | `env*` | All envs present |
| 2 | `env[!X]` | 1 missing, single digit only |
| 3 | `env{n..m}` | Everything else (brace expansion) |

**Examples:**
```
10/10 envs        → env*
9/10 (miss env5)  → env[!5]
env0-env7         → env{0..7}
36/37 (miss env5) → env{0..4,6..36}
env10-env25       → env{10..25}
env1,3,7          → env{1,3,7}
```

### Nested Scanning Behavior

**Always scan nested** for env folders - `-R` only controls display:

| Layer | Nested Scan | Display (no -R) | Display (-R) |
|-------|-------------|-----------------|--------------|
| `raw/env*` | Always | `(n nested)` count | Full tree |
| `bronze/` | No | Folder only | Folder only |
| `silver/` | No | Folder only | Folder only |
| `gold/` | No | Folder only | Folder only |
| `platinum/` | Always | `(n nested)` count | Full tree |

### Layer Types Added

```python
LAYER_CONFIG = {
    "raw": LayerACL(need_default=True),
    "env": LayerACL(need_default=True),
    "env_nested": LayerACL(need_default=True),
    "bronze": LayerACL(),
    "silver": LayerACL(),
    "gold": LayerACL(),
    "platinum": LayerACL(),
    "platinum_nested": LayerACL(),
}
```

### Exit Code Behavior

- Returns `1` if ANY issue (including nested)
- Nested issues affect exit code even without `-R`

### Code Changes

| Function | Change |
|----------|--------|
| `format_env_pattern()` | Smart glob: `env*` > `env[!X]` > `env{n..m}` |
| `get_paths()` | Always scan nested, return `nested_count` |
| `check_all()` | Include `nested` in results |
| `print_tree()` | Filter display based on `show_nested` flag |

### TODO (In Progress)

- `-R` flag: Show individual envs (no grouping) with full tree
- `-i` flag: Discuss later

### Stashed Changes

```bash
git stash list
# WIP on feature/acl-checker-refactor: b164fa0 docs: update acl_checker...
```
