# Session: 2026-01-22 (Windows)

## Summary
- bbocax grabber map verification
- Date extraction analysis: filename suffix vs mtime

---

## bbocax Grabber Maps - Date Extraction

All bbocax grabber maps use **filename timestamp**, NOT mtime.

### Two-Pattern Strategy

Each grabber map has two patterns per file type:

| Priority | Source | Example |
|----------|--------|---------|
| **Primary** | Filename date suffix | `curncyAsia1.parquet.20251214` → extracts `20251214` |
| **Fallback** | Directory path (mtime-based) | `silver/2025/12/14/work/...` |

### Grabber Maps Verified

| Grabber Map | Date Source | Branch |
|-------------|-------------|--------|
| `backoffice_1_0` | Filename suffix / Directory | dev |
| `backoffice_cax_1_0` | Filename suffix / Directory | dev |
| `backoffice_cax_2_0` | Filename suffix / Directory | dev |
| `backoffice_parquet_2_0` | Filename suffix / Directory | dev |
| `corporate_actions_1_0` | Filename suffix / Directory | dev |
| `corporate_actions_cax_1_0` | Filename suffix / Directory | dev |
| `corporate_actions_cax_2_0` | Filename suffix / Directory | dev |
| `futures_2_0` | Filename suffix / Directory | dev |
| `currency_1_0` | Filename suffix / Directory | feature/bbocax-currency |
| `currency_parquet_1_0` | Filename suffix / Directory | feature/bbocax-currency |

---

## Pipeline Date Flow

```
RAW (cwiq_pipe)
└── env0/curncyAsia1.parquet.20251214        ← Bloomberg provides date suffix

BRONZE (mtime-based)
└── 2025/12/14/020609-0500--curncyAsia1.parquet.20251214
    ↑ directory    ↑ time prefix  ↑ original filename preserved

SILVER
└── 2025/12/14/work/020609-0500--curncyAsia1.parquet.20251214

GOLD (grabber map extracts date)
└── back_office_currency/1.0/raw/2025/20251214/curncyAsia1.parquet
                              ↑ from filename    ↑ suffix stripped
```

### Date Sources

| Layer | Date Source | Used For |
|-------|-------------|----------|
| Bronze | mtime | Directory structure (`YYYY/MM/DD/`), time prefix (`HHMMSS--`) |
| Silver | Preserved | Same as bronze |
| Gold | Filename suffix (primary) | Output directory (`YYYY/YYYYMMDD/`) |
| Gold | Directory path (fallback) | When no filename suffix |

---

## Grabber Map Pattern Examples

### With Filename Date Suffix (Primary)
```regex
\.parquet\.(?P<y>\d{4})(?P<m>\d{2})(?P<d>\d{2})$
```
Matches: `curncyAsia1.parquet.20251214`

### Without Date Suffix (Fallback)
```regex
silver/(?P<y>\d{4})/(?P<m>\d{2})/(?P<d>\d{2})/work/...
```
Uses directory date from mtime

---

## Validation Paths (Confirm No Date Suffix in Output)

- Currency: `/bloomberg/back_office_currency/1.0/raw/{YYYY}/{YYYYMMDD}/curncyAsia1.csv`
- Futures: `/bloomberg/back_office_futures/2.0/raw/share_futures/{YYYY}/{YYYYMMDD}/shareFuturesBulkEuro.dif`

Output filenames do NOT have date suffix - suffix is stripped and used for directory only.

---

## Branches Checked

| Branch | Content |
|--------|---------|
| `dev` | All bbocax grabber maps except currency |
| `feature/bbocax-currency` | Currency grabber maps (`currency_1_0`, `currency_parquet_1_0`) |
| `feature/bbocax-mapping` | Older bbocax work (no grabber maps on this branch) |

---

## Key Files

- `data_alchemy/handlers/enrich_bronze_fp.py` - Uses mtime for bronze path
- `data_alchemy/handlers/handle_gold.py` - Applies grabber map transformations
- `resc/grabber_maps/bloomberg_bbocax_cwiq_pipe_*.json` - Grabber map definitions
