# Session: 2026-01-27 (Linux)

## Context
- **Repo**: alchmy
- **Branch**: feature/bbocax-additional-split-services (data-alchemy)

## Synced from Windows Session

See `w-2026-01-27.md` for full context including:
- rsync commands for bloomberg data copy
- BBOCAX split service commands (8 patterns)
- Bloomberg DES binary issue
- Python venv setup on remote server

---

## Next Steps (from Windows)
- [ ] Complete rsync copy of bloomberg data
- [ ] Run data-alchemy with split service patterns
- [ ] Fix Bloomberg DES binary path
- [ ] Merge feature/backfill-date-range-clean to dev
- [ ] Merge feature/bbocax-preferred-exch to dev
- [ ] Implement per-dataset backfill hours configuration

---

## Work Done (Linux)

### bbocax Equities Branch Setup

**Branch:** `feature/bbocax-equities`

**Actions:**
1. Merged `origin/dev` - resolved conflict in `silver_decrypt_inclusions/bloomberg.json`
2. Cherry-picked equities service files from `feature/bbocax-additional-split-services`
3. Added equities to Ansible playbooks
4. Fixed grabber map patterns to exclude CorporateActions files

### Commits Pushed

| Commit | Description |
|--------|-------------|
| `43c2f3c` | merge origin/dev into feature/bbocax-equities |
| `f99c195` | feat: add back_office_equities service files for bbocax |
| `6ab9349` | docs: add back_office_equities to ansible playbooks |
| `7656739` | fix: exclude CorporateActions from equities grabber map patterns |

**MR:** [!490](https://git.codewilling.com/data/cwiq-pipe/data-alchemy/-/merge_requests/490)

### Grabber Map Fix (CorporateActions Exclusion)

**Issue:** Test failures showed `equityAsia1CorporateActionsV2.parquet` incorrectly matched by equities grabber map instead of going to corporate_actions 2.0.

**Pattern Change:**
```
# Before
equity(?!Options|Index)[^/]*

# After
equity(?!Options|Index)(?!.*CorporateActions)[^/]*
```

**Files Updated:**
- `resc/grabber_maps/bloomberg_bbocax_cwiq_pipe_equities_parquet_1_0.json`
- `resc/grabber_maps/bloomberg_bbocax_cwiq_pipe_equities_1_0.json`

**Service Files:** Already correct - FILE_PATTERN has `(?!.*(CorporateActions|\.cax))` exclusion.

### Playbook Status

| Playbook | Status |
|----------|--------|
| `deploy-data-alchemy-prod06.yml` | Equities commented out |
| `deploy-data-alchemy-staging.yml` | Equities active |
| `deploy-data-alchemy-prod.yml` | No equities entries |

### Equities FILE_PATTERN (Verified)

```
(equity(Asia1|Asia2|Euro|Lamr|Namr|MifidEuro)(?!.*(CorporateActions|\.cax))|equity_(asia1|asia2|euro|lamr|namr|mifid_euro)(?!\.cax))
```

**Coverage:** 118 files/weekday (78 CamelCase + 40 underscore)

### Platinum Verification

| Date Type | Files |
|-----------|-------|
| Weekdays | 118 |
| Weekends | 48 |

**DQ orphaned files:** Expected (CDP reference incomplete)

### Run Command

```bash
uv run python -m data_alchemy.main \
    --vendor bloomberg \
    --dataset bbocax_cwiq_pipe \
    --version 1.0 \
    --backfill 5000 \
    --ignore-db \
    --db-name '{vendor}--{ds}--back_office_equities' \
    --file-pattern '(equity(Asia1|Asia2|Euro|Lamr|Namr|MifidEuro)(?!.*(CorporateActions|\.cax))|equity_(asia1|asia2|euro|lamr|namr|mifid_euro)(?!\.cax))' \
    2>&1 | tee ~/bbocax_equities_$(date +%Y%m%d_%H%M%S).log
```

---

## bbocax Futures Extended Branch

**Branch:** `feature/bbocax-futures-ext`
**MR:** [!484](https://git.codewilling.com/data/cwiq-pipe/data-alchemy/-/merge_requests/484)

### Grabber Map Changes

**Issue:** Parquet files were incorrectly marked with `gzip_no_ext` compression. Parquet files are native Apache Parquet format (no compression), while other formats (.csv, .cax, .px, etc.) are gzip compressed.

**Solution:** Split grabber maps following currency pattern:
- Non-parquet files: keep `gzip_no_ext` compression
- Parquet files: separate files with no compression field

**Files Modified:**
| File | Change |
|------|--------|
| `futures_extended_1_0.json` | Removed parquet from extensions |
| `futures_extended_2_0.json` | Removed parquet from extensions |
| `futures_extended_3_0.json` | Removed parquet from extensions |

**Files Created:**
| File | Description |
|------|-------------|
| `futures_extended_parquet_1_0.json` | Non-V2/V3 parquet files |
| `futures_extended_parquet_2_0.json` | V2 parquet files |
| `futures_extended_parquet_3_0.json` | V3 parquet files |

### Service Files

Cherry-picked from `feature/bbocax-additional-split-services`:
- `data-alchemy-prod-bloomberg-1.0-bbocax-back_office_futures_extended.service`
- `data-alchemy-staging-bloomberg-1.0-bbocax-back_office_futures_extended.service`

**FILE_PATTERN:** `(share|nonShare)FuturesExtended`

### Playbook Status

| Playbook | Status |
|----------|--------|
| `deploy-data-alchemy-prod06.yml` | Commented out |
| `deploy-data-alchemy-staging.yml` | Active |

### Commits

| Commit | Description |
|--------|-------------|
| `ea538e5` | feat: add futures_extended grabber maps and service files |
| `06b8f4e` | merge: origin/dev into feature/bbocax-futures-ext |
| `aac6357` | style: format bloomberg_decrypt.py with black |

---

## Corporate Actions FILE_PATTERN Analysis

### Complete File List (from /sf/data)

**corporate_actions dataset:**
- Legacy: `equity_asia1.cax`, `equity_asia2.cax`, `equity_euro.cax`, `equity_lamr.cax`, `equity_namr.cax`
- 1.0 parquet: `equityAsia1CorporateActions.parquet`, etc
- 1.0 effDt: `effDtEquityAsia1CorporateActions.cax`, `effDtEquityAsia1CorporateActionsCorporateActions.parquet`
- 2.0 V2: `equityAsia1CorporateActionsV2.cax`, `equityAsia1CorporateActionsV2.parquet`
- 2.0 premarket: `premarketEquityAsia1CorporateActionsV2.cax`, `premarketEquityAsia1CorporateActionsV2CorporateActions.parquet`

**back_office_preferred_exch_corporate_actions dataset:**
- Legacy: `pfd_exch_asia.cax`, `pfd_exch_euro.cax`, `pfd_exch_lamr.cax`, `pfd_exch_namr.cax`
- 1.0 parquet: `pfdExchAsiaCorporateActions.parquet`, etc
- 1.0 effDt: `effDtPfdExchAsiaCorporateActions.cax`, `effDtPfdExchAsiaCorporateActionsCorporateActions.parquet`
- 2.0 V2: `pfdExchAsiaCorporateActionsV2.cax`, `pfdExchAsiaCorporateActionsV2CorporateActions.parquet`
- 2.0 premarket: `premarketPfdExchAsiaCorporateActionsV2.cax`, `premarketPfdExchAsiaCorporateActionsV2CorporateActions.parquet`

### Grabber Maps (8 total)

**corporate_actions:**
| Grabber Map | Target | Compression |
|-------------|--------|-------------|
| `corporate_actions_1_0.json` | 1.0 | none (parquet) |
| `corporate_actions_cax_1_0.json` | 1.0 | gzip_no_ext |
| `corporate_actions_cax_2_0.json` | 2.0 | gzip_no_ext |
| `corporate_actions_parquet_2_0.json` | 2.0 | none |

**back_office_preferred_exch_corporate_actions:**
| Grabber Map | Target | Compression |
|-------------|--------|-------------|
| `backoffice_1_0.json` | 1.0 | none (parquet) |
| `backoffice_cax_1_0.json` | 1.0 | gzip_no_ext |
| `backoffice_cax_2_0.json` | 2.0 | gzip_no_ext |
| `backoffice_parquet_2_0.json` | 2.0 | none |

### FILE_PATTERN Issues Found

**corporate_actions (CURRENT):**
```
(equity_(asia1|asia2|euro|lamr|namr)\.cax|(equity|effDt).+CorporateActions)
```

**Issues:**
1. `effDt.+CorporateActions` matches `effDtPfdExch*` (should go to back_office)
2. Missing `premarket` prefix for V2 files

**back_office_preferred_exch_corporate_actions (CURRENT):**
```
(pfdExch(Asia|Euro|Lamr|Namr)CorporateActions|pfd_exch_(asia|euro|lamr|namr)\.cax)
```

**Issues:**
1. Missing `effDtPfdExch*` files
2. Missing `premarketPfdExch*` files
3. Missing V2 suffix matching

### Recommended FILE_PATTERNs

**corporate_actions:**
```
(equity_(asia1|asia2|euro|lamr|namr)\.cax|(equity|effDtEquity|premarketEquity).+CorporateActions)
```

**back_office_preferred_exch_corporate_actions:**
```
(pfd_exch_(asia|euro|lamr|namr)\.cax|(pfdExch|effDtPfdExch|premarketPfdExch).+CorporateActions)
```

### Production Analysis

**Current CDP Output:**
- `effDtPfdExch*` files: 94 in corporate_actions, 0 in back_office_preferred_exch
- This means effDtPfdExch files go to corporate_actions (not back_office)

**Decision:** Production is working, DQ passed. Leave grabber maps as-is.
- The current routing may be intentional
- Service FILE_PATTERNs updated but grabber maps NOT changed

### Service FILE_PATTERN Updates (Committed)

**Commit:** `9eabef5` - fix: update corporate_actions FILE_PATTERN to handle effDt and premarket files correctly

**Files Updated:**
- `data-alchemy-staging-bloomberg-1.0-bbocax-corporate_actions.service`
- `data-alchemy-prod-bloomberg-1.0-bbocax-corporate_actions.service`
- `data-alchemy-staging-bloomberg-1.0-bbocax-back_office_preferred_exch_corporate_actions.service`
- `data-alchemy-prod-bloomberg-1.0-bbocax-back_office_preferred_exch_corporate_actions.service`

---

## Branch: feature/bbocax-corporate-actions

**MR:** [!491](https://git.codewilling.com/data/cwiq-pipe/data-alchemy/-/merge_requests/491)

### Grabber Map Mixing Issue

**Problem Found:**
- `effDtPfdExch*CorporateActions.parquet` files (94 total) were routing to `corporate_actions/` instead of `back_office_preferred_exch_corporate_actions/`
- Production was already working this way, DQ passed

**Decision:** Combine both services into ONE `corporate_actions` service

### Root Cause Analysis

**corporate_actions_1_0.json pattern:**
```regex
(?:equity|pfdExch(?!(?:Asia|Euro|Lamr|Namr)CorporateActions\.parquet)|effDt|premarket)...CorporateActions
```

**backoffice_1_0.json pattern:**
```regex
pfdExch(?:Asia|Euro|Lamr|Namr)CorporateActions\.parquet
```

**The Problem:** corporate_actions pattern has 4 prefix alternations:
```
equity | pfdExch(with exclusion) | effDt | premarket
```

But `effDt` and `premarket` have **NO exclusion for pfdExch files**!

**File Routing Issue:**

| File | Which Pattern Matches | Goes To |
|------|----------------------|---------|
| `equityAsia1CorporateActions.parquet` | `equity` in corporate_actions | corporate_actions ✅ |
| `pfdExchAsiaCorporateActions.parquet` | backoffice pattern | backoffice ✅ |
| `effDtEquityAsia1CorporateActions.parquet` | `effDt` in corporate_actions | corporate_actions ✅ |
| `effDtPfdExchAsiaCorporateActions.parquet` | `effDt` in corporate_actions | corporate_actions ❌ |
| `premarketPfdExchAsiaCorporateActions.parquet` | `premarket` in corporate_actions | corporate_actions ❌ |

**Why It Happened:**
```
effDt     → matches EVERYTHING starting with effDt
                 ↓
         effDtPfdExch... matched by corporate_actions (WRONG)
         effDtEquity... matched by corporate_actions (correct)
```

The backoffice pattern **only handles simple cases**:
```
pfdExch(Asia|Euro|Lamr|Namr)CorporateActions.parquet
```

It **doesn't handle**:
- `effDtPfdExch...` (prefix before pfdExch)
- `premarketPfdExch...` (prefix before pfdExch)

**Fix Options Were:**
1. **Fix grabber maps** - Add `effDtPfdExch` and `premarketPfdExch` to backoffice, exclude from corporate_actions
2. **Combine services** - Since production works and DQ passed, merge into one service ✅ (chosen)

**Summary:** `effDt` and `premarket` prefixes in corporate_actions grabber map match **all** files with those prefixes, including pfdExch files that should go to backoffice

### Changes Made

**1. Deleted Service Files:**
- `data-alchemy-prod-bloomberg-1.0-bbocax-back_office_preferred_exch_corporate_actions.service`
- `data-alchemy-staging-bloomberg-1.0-bbocax-back_office_preferred_exch_corporate_actions.service`

**2. Removed from Ansible Playbooks:**
- `deploy-data-alchemy-staging.yml` - removed back_office_preferred_exch entries
- `deploy-data-alchemy-prod06.yml` - removed commented entries

**3. Updated corporate_actions FILE_PATTERN:**

Initial pattern (too broad - matched JSON files):
```
(CorporateActions|equity_(asia1|asia2|euro|lamr|namr)\.cax|pfd_exch_(asia|euro|lamr|namr)\.cax)
```

**Final pattern (prefix-restricted):**
```
((equity|pfdExch|effDt|premarket).+CorporateActions|equity_(asia1|asia2|euro|lamr|namr)\.cax|pfd_exch_(asia|euro|lamr|namr)\.cax)
```

### Why Prefix-Restricted Pattern

**Problem:** Original `CorporateActions` pattern would match unwanted JSON files:
- `5115-GlobalEquityCorporateActionsEdit.json.gz` ❌ Should NOT match

**Solution:** Require known prefixes `(equity|pfdExch|effDt|premarket)` before `CorporateActions`

### Pattern Coverage (Verified)

| File Type | Examples | Status |
|-----------|----------|--------|
| Legacy .cax 1.0 | `equity_asia1.cax`, `pfd_exch_euro.cax` | ✅ |
| CamelCase .parquet 1.0 | `equityAsia1CorporateActions.parquet` | ✅ |
| V2 .cax/.parquet 2.0 | `V2equityAsia1CorporateActions.parquet` | ✅ |
| effDt variants | `effDtEquityAsia1CorporateActions.parquet` | ✅ |
| premarket variants | `premarketEquityAsia1CorporateActions.parquet` | ✅ |
| pfdExch all variants | `pfdExchAsiaCorporateActions.parquet` | ✅ |
| Unwanted JSON | `5115-GlobalEquityCorporateActionsEdit.json.gz` | ❌ Excluded |

### Commits

| Commit | Description |
|--------|-------------|
| `9b99e38` | feat: combine corporate_actions and back_office_preferred_exch into single service |
| `f26460e` | fix: update corporate_actions FILE_PATTERN to exclude unwanted JSON files |

### Grabber Maps (All 8 route to combined output)

| Map | Files | Version |
|-----|-------|---------|
| `corporate_actions_1_0.json` | equity parquet 1.0 | 1.0 |
| `corporate_actions_cax_1_0.json` | equity_.cax 1.0 | 1.0 |
| `corporate_actions_cax_2_0.json` | V2equity.cax 2.0 | 2.0 |
| `corporate_actions_parquet_2_0.json` | V2equity parquet 2.0 | 2.0 |
| `backoffice_1_0.json` | pfdExch parquet 1.0 | 1.0 |
| `backoffice_cax_1_0.json` | pfd_exch_.cax 1.0 | 1.0 |
| `backoffice_cax_2_0.json` | V2pfdExch.cax 2.0 | 2.0 |
| `backoffice_parquet_2_0.json` | V2pfdExch parquet 2.0 | 2.0 |

---
