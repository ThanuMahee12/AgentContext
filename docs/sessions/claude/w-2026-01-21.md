# Session: 2026-01-21 (Windows)

## Summary
- ACL Checker branch review and comparison
- Fixed 10 bugs in acl_checker.py
- Tested with trth_api_cwiq_pipe and factset_all_cwiq_pipe datasets

---

## Work Log

### ACL Checker Branch Review

**Two ACL branches found in data-alchemy:**

| Branch | Last Commit | Date | Status |
|--------|-------------|------|--------|
| `feature/acl-checker-refactor` | `b150df9` | 2026-01-21 | **Latest** |
| `feature/acl-handler-refactor` | `0efdad1` | 2026-01-14 | Older |

### Bug Fixes (10 commits)

| Commit | Fix |
|--------|-----|
| `0d98409` | Use keyword arg for `check_default` parameter (was passing bool as `expected` string) |
| `c1d07bc` | Add `ACCESS_DENIED` to issues-only output (was missing from `-i` flag) |
| `c1a30d3` | Group env directories under raw layer with permission grouping |
| `08b2b24` | White paths with colored headers in issues-only output |
| `6ca07f5` | Group envs by status in tree view |
| `93000a8` | Group nested dirs with count |
| `f4f92cf` | Use direct ranges instead of exclusion patterns (e.g., `env[1-36]` not `env[!0,37-44]`) |
| `6bd9b4d` | Group env paths in `-i` output |
| `00e53c9` | Add exclusion and open-ended patterns (`env[!X]`, `env[n-*]`) |
| `ef273c3` | Show `env*` when consecutive from 0 |
| `b150df9` | Show full path with env pattern in tree view |

### Root Cause of Main Bug

**Problem:** All paths showed `NO_REGULAR_ACL` even when ACL was correct.

**Cause:** In `check_all()`, the call was:
```python
get_acl(str(p), user, chk)  # WRONG - chk (bool) passed as expected (str)
```

**Fix:**
```python
get_acl(str(p), user, check_default=chk)  # CORRECT - use keyword arg
```

### Test Results (trth_api_cwiq_pipe)

```bash
uv run python scripts/pre_deployment_verification/acl_checker.py \
  -v lseg_refinitiv -d trth_api_cwiq_pipe -i
```

**Output:**
- Missing rwx: 1 (platinum target)
- Missing default rwx: 1 (env0)
- Access denied: 13 (dated folders on platinum targets)

---

## CLI Flags (acl_checker.py)

| Flag | Short | Default | Description |
|------|-------|---------|-------------|
| `--vendor` | `-v` | None | Vendor name |
| `--dataset` | `-d` | None | Dataset name |
| `--version` | `-V` | `1.0` | Version |
| `--dataset-path` | `-p` | None | Full dataset path |
| `--check` | `-c` | None | Check any path |
| `--user` | `-u` | `svc_dat_alchemy` | User to verify |
| `--expected` | | `rwx` | Expected permission |
| `--issues-only` | `-i` | False | Grouped list output |
| `--fp-prefix` | | `/sf/data` | Data root |
| `--env` | `-e` | `env*` | Env pattern filter |
| `--recursive` | `-R` | False | Recursive scan |

---

## Notes

- MR: https://git.codewilling.com/data/cwiq-pipe/data-alchemy/-/merge_requests/466
- `feature/acl-handler-refactor` has filename-to-glob pattern feature but no tests
- ACCESS_DENIED on dated folders = getfacl returns "Operation not permitted"

---

## Env Pattern Formats

| Pattern | When Used | Example |
|---------|-----------|---------|
| `env*` | All envs consecutive from 0 | 17 envs (0-16) |
| `env[n-m]` | Consecutive range | `env[1-36]` |
| `env[n-*]` | Range to last env | `env[5-*]` (5 to max) |
| `env[!X]` | All except 1-2 missing | `env[!0]` |
| `env[!X,Y]` | All except 2 missing | `env[!0,5]` |

---

## Next Steps
- [x] Fix check_default parameter bug
- [x] Add ACCESS_DENIED to -i output
- [x] Group env directories under raw
- [x] White paths in -i output
- [x] Group envs by status
- [x] Group nested dirs with count
- [x] Use direct ranges (env[1-36])
- [x] Group env paths in -i output
- [x] Add exclusion patterns (env[!X])
- [x] Show env* when consecutive from 0
- [x] Show full path with env pattern
- [ ] Test with more datasets

