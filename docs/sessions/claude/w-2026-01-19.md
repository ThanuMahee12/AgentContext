# Session: 2026-01-19 (Windows)

## Summary
- LSEG Refinitiv data review - rsync copy from raw to data_review
- htop debugging guide
- SP estimate zip command
- InvestigationDB: Enhanced CDP CSV extraction (36 vendors, 149 source paths)

---

## LSEG Refinitiv Data Copy

### Task
Copy raw files from `/sf/data/lseg_refinitiv/reuters_fundamentals/1.0/raw/` to data review folder for analysis.

### Source Paths (derived → raw mapping)
Derived path pattern:
```
/sf/data/lseg_refinitiv/reuters_fundamentals/1.0/derived/financial_statement_values_interim/YYYY/YYYYMMDD/
```

Raw path pattern:
```
/sf/data/lseg_refinitiv/reuters_fundamentals/1.0/raw/YYYY/YYYYMMDD/
```

### Directories Copied
```
2025: 20251211, 20251212, 20251215, 20251229, 20251230, 20251231
2026: 20260101, 20260102, 20260105, 20260106, 20260107, 20260108, 20260109, 20260112, 20260113, 20260114, 20260115
```

### Server-Friendly rsync Command
```bash
mkdir -p /sf/proj/data_alchemy/assets/prod/data_review/data && \
nice -n 19 ionice -c2 -n7 rsync -avh --progress --relative --bwlimit=50000 \
  /sf/data/./lseg_refinitiv/reuters_fundamentals/1.0/raw/2025/20251211/ \
  /sf/data/./lseg_refinitiv/reuters_fundamentals/1.0/raw/2025/20251212/ \
  /sf/data/./lseg_refinitiv/reuters_fundamentals/1.0/raw/2025/20251215/ \
  /sf/data/./lseg_refinitiv/reuters_fundamentals/1.0/raw/2025/20251229/ \
  /sf/data/./lseg_refinitiv/reuters_fundamentals/1.0/raw/2025/20251230/ \
  /sf/data/./lseg_refinitiv/reuters_fundamentals/1.0/raw/2025/20251231/ \
  /sf/data/./lseg_refinitiv/reuters_fundamentals/1.0/raw/2026/20260101/ \
  /sf/data/./lseg_refinitiv/reuters_fundamentals/1.0/raw/2026/20260102/ \
  /sf/data/./lseg_refinitiv/reuters_fundamentals/1.0/raw/2026/20260105/ \
  /sf/data/./lseg_refinitiv/reuters_fundamentals/1.0/raw/2026/20260106/ \
  /sf/data/./lseg_refinitiv/reuters_fundamentals/1.0/raw/2026/20260107/ \
  /sf/data/./lseg_refinitiv/reuters_fundamentals/1.0/raw/2026/20260108/ \
  /sf/data/./lseg_refinitiv/reuters_fundamentals/1.0/raw/2026/20260109/ \
  /sf/proj/data_alchemy/assets/prod/data_review/data/
```

### Server-Friendly Flags Explained
| Flag | Purpose |
|------|---------|
| `nice -n 19` | Lowest CPU priority |
| `ionice -c2 -n7` | Best-effort I/O, lowest priority |
| `--bwlimit=50000` | Limit bandwidth to 50MB/s |
| `--relative` with `.` | Preserves directory structure from the `.` marker |

### Result
- Transferred: 10.23G
- Error code 23: Some files had permission issues (minor)

### Destination Structure
```
/sf/proj/data_alchemy/assets/prod/data_review/data/lseg_refinitiv/reuters_fundamentals/1.0/raw/YYYY/YYYYMMDD/
```

---

## htop Debugging Guide

### Launch Options
```bash
htop                    # Standard launch
htop -u $USER           # Show only your processes
htop -p PID1,PID2       # Monitor specific PIDs
htop -t                 # Tree view
```

### Key Shortcuts
| Key | Action |
|-----|--------|
| `F1`/`?` | Help |
| `F2` | Setup/Config |
| `F3`/`/` | Search process |
| `F4`/`\` | Filter processes |
| `F5` | Tree view toggle |
| `F6` | Sort by column |
| `F9`/`k` | Kill process |
| `P` | Sort by CPU |
| `M` | Sort by Memory |
| `I` | Sort by I/O |

### Process States
| State | Meaning |
|-------|---------|
| `R` | Running |
| `S` | Sleeping |
| `D` | Disk sleep (I/O wait) |
| `Z` | Zombie |
| `T` | Stopped |

### CPU Bar Colors
| Color | Meaning |
|-------|---------|
| Green | Normal user processes |
| Red | Kernel processes |
| Blue | Low priority (nice > 0) |
| Cyan | Virtualized |
| Gray | I/O wait |

### Memory Bar Colors
| Color | Meaning |
|-------|---------|
| Green | Used memory |
| Blue | Buffers |
| Orange | Cache |
| Empty | Free |

### Useful Columns to Enable (F2 → Columns)
- `IO_READ_RATE`, `IO_WRITE_RATE` - Disk I/O
- `STARTTIME` - When process started
- `OOM` - OOM killer score
- `RBYTES`, `WBYTES` - Total bytes read/written

---

## SP Estimate Zip Command

### Task
Zip the SP estimate output folder for 2026-01-19.

### Command
```bash
zip -r sp-estimate-19012026.zip /home/bthanujan.mahendran/output/20260119
```

### Flags
| Flag | Purpose |
|------|---------|
| `-r` | Recursive (include subdirectories) |

---

## Notes
- Data review location: `/sf/proj/data_alchemy/assets/prod/data_review/data/`
- Use `nice`/`ionice` for server-friendly operations
- rsync `--relative` with `.` marker preserves path structure from that point

---

## InvestigationDB: CDP CSV Extraction

### Task
Enhanced `inverstigationdb` to extract vendors and source paths from CDP CSV instead of just grabber_maps.

### Changes to parse_cdp_csv.py
- Added `extract_vendor_dataset_version()` - extracts vendor/dataset/version from raw_enriched paths
- Added `derive_source_path()` - derives cwiq-pipe raw path from vendor/dataset/version
- Now generates: `vendor.jsonl`, `source_path.jsonl`, `source_pattern.jsonl`

### Database Stats (After)

| Table | Records | Source |
|-------|---------|--------|
| vendor | 36 | CDP CSV |
| source_path | 149 | CDP CSV (derived) |
| source_pattern | 3,030 | CDP CSV (derived) |
| dataset_repo | 128 | CDP CSV |
| delta_table | 3,702 | CDP CSV |
| raw_enriched_path | 1,451 | CDP CSV |

### Key Derivation Logic
```
raw_enriched: /sf/data/{vendor}/{dataset}/{version}/raw_enriched/...
     source: /sf/data/{vendor}/{dataset}/{version}/raw
```

### Example Trace
```
delta_table: combined_day_sym_seg_brand_channel_emax
  -> repo: dataset-v2-ce-transact-daily-signal-usa
  -> raw_enriched: /sf/data/consumer_edge/transact_daily_signal_usa/1.0/raw_enriched/...
  -> vendor: consumer_edge
  -> source: /sf/data/consumer_edge/transact_daily_signal_usa/1.0/raw
```

### Commands
```bash
cd C:\Users\thanu\Downloads\inverstigationdb
python scripts/parse_cdp_csv.py      # Regenerate JSONL
rm db/investigation.db               # Delete old DB
python scripts/load_jsonl.py --reset # Reload
```

### Vendors Extracted (36)
consumer_edge, cw, apptopia, barclays, msci_barra, bloomberg, cme, crunchbase, datos, dtcc, factset, ascential_flywheel, hazeltree, schonfeld, jp_morgan, lseg_refinitiv, sp_global_mi, morgan_stanley, ssa, ubs...
