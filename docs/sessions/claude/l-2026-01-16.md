# 2026-01-16

## Project: data-alchemy

**Repo:** alchmy (parent) + data-alchemy (submodule)

**Environment:** Linux machine

**Branch:** `feature/bbocax-futures-v2`

---

### Progress Today

**Session 1:**
- Pulled AgentContext updates
- Created Linux session file
- Ran datasette on `cdp_retirement.db` (port 8001)

**Session 2: bbocax-futures restore**
- Yesterday's futures changes were reverted in dev (`50a4a4e`)
- Created new branch `feature/bbocax-futures-v2` from dev
- Reverted the revert to restore grabber map changes only
- Kept only `bloomberg_bbocax_cwiq_pipe_futures_2_0.json` changes:
  - `compression: "gzip_no_ext"`
  - `validation` as array format
- Pushed to origin: commit `710ab8b`

**Session 3: Time window analysis queries**
- Created SQL query to analyze bbocax file delivery times (30-min/1-hour buckets)
- Patterns for all 5 target paths:
  - `pfdExch%`, `pfd_exch_%` → `back_office_preferred_exch_corporate_actions`
  - `equity%`, `premarket%` → `corporate_actions`
  - `shareFuturesBulk%`, `nonShareFuturesBulk%` → `back_office_futures`

**Session 4: Permission errors**
- Gold layer permission errors on:
  - `/sf/data/bloomberg/back_office_preferred_exch_corporate_actions/1.0/raw/2026/20260116/`
  - `/sf/data/bloomberg/back_office_preferred_exch_corporate_actions/2.0/raw/2026/20260116/`

---

### SQL Queries

**Time window analysis (backoffice + futures):**
```sql
WITH bucketed AS (
  SELECT
    date_trunc('hour', mtime)
      + floor(extract(minute FROM mtime) / 60) * interval '1 hour' AS time_window,
    mtime::date AS mtime_date
  FROM cwiq_pipe_file_status
  WHERE dataset = 'bbocax_cwiq_pipe'
    AND delivered = true
    AND mtime >= current_date - interval '6 days'
    AND mtime::time >= time '11:00'
    AND mtime::time <  time '18:00'
    AND (
      source_location LIKE '%pfdExch%'
      OR source_location LIKE '%pfd_exch_%'
      OR source_location LIKE '%shareFuturesBulk%'
      OR source_location LIKE '%nonShareFuturesBulk%'
    )
)
SELECT
  to_char(time_window, 'HH24:MI') AS time_slot,
  COUNT(*) FILTER (WHERE mtime_date = current_date)     AS "Today",
  COUNT(*) FILTER (WHERE mtime_date = current_date - 1) AS "Yesterday"
FROM bucketed
GROUP BY time_slot
ORDER BY time_slot;
```

**data-alchemy filemetadata table query:**
```sql
SELECT stratum, input_filepath, output_filepath, processed_time
FROM filemetadata
WHERE input_filepath LIKE '%pfdExchEuroCorporateActionsV2.cax%'
   OR output_filepath LIKE '%pfdExchEuroCorporateActionsV2.cax%'
ORDER BY processed_time;
```

---

### Linux Commands

**Platinum file count (last 10 days):**
```bash
for i in 0 1 2 3 4 5 6 7 8 9; do d=$(date -d "-$i days" +%Y%m%d); y=$(date -d "-$i days" +%Y); s=$(ls /sf/data/bloomberg/back_office_futures/2.0/raw/share_futures/$y/$d/ 2>/dev/null | wc -l); n=$(ls /sf/data/bloomberg/back_office_futures/2.0/raw/non_share_futures/$y/$d/ 2>/dev/null | wc -l); echo "$(date -d "-$i days" +%b\ %d): share=$s non_share=$n total=$((s+n))"; done
```

**Rsync sqlite files:**
```bash
rsync -av --include='*/' --include='*.sqlite' --exclude='*' /sf/data/bloomberg/bbocax_cwiq_pipe/1.0/silver/ /sf/proj/data_alchemy/thanudev/output/silver/
```

**Find folders without sqlite:**
```bash
for dir in /sf/data/bloomberg/bbocax_cwiq_pipe/1.0/silver/*/*/*/*/; do c=$(ls "$dir"*.sqlite 2>/dev/null | wc -l); if [ "$c" -eq 0 ]; then echo "$dir"; fi; done
```

---

### Context from Yesterday

**bbocax-futures:**
- `gzip_no_ext` compression fix committed (`6aa26f0`)
- DQ validation approach established
- Expected 38 files/day (20 share + 18 non_share)

**bbocax-currency:**
- Split grabber maps: `_currency_1_0.json` + `_currency_parquet_1_0.json`
- DQ should use date range `20251118+` (CSV/parquet only available from that date)

---

### Pending

- Fix permission errors on `back_office_preferred_exch_corporate_actions` directories
- Verify futures grabber map after MR merge

---
