# Session: 2026-01-23 (Linux)

## Summary
- Fixed dynamic `db_name` in cleanup functions (db.py)
- Added `DB_NAME` support to service shell scripts
- Verified equities grabber map coverage (all 102 files covered)
- Installed sqlite3 on dev server
- Server storage check on ny5-predpalch01

---

## Work Log

### Server Storage Check (ny5-predpalch01)

| Filesystem | Mount | Total | Used | Free | Use% |
|------------|-------|-------|------|------|------|
| `vg00-root` | `/` | 120G | 49G | 72G | 41% |
| `vglocal-local` | `/local` | 1.0T | 30G | 994G | 3% |
| `cwiqfs` | `/sf` | 7.3E | 5.1P | 7.3E | 1% |
| `vg00-var` | `/var` | 50G | 1.9G | 49G | 4% |

### Bug Fix: Dynamic db_name in Cleanup Functions

**Issue:** Cleanup functions were hardcoded to `{vendor}--{dataset}.sqlite`, ignoring custom `db_name`.

**Files changed:**
- `data_alchemy/utils/db.py` - Added `db_name` param to:
  - `cleanup_previous_day_sqlite_if_empty()`
  - `cleanup_old_sqlite_dbs_after_gold()`
- `data_alchemy/main.py` - Pass `db_name` to cleanup function

**Branch:** `feature/db-name-flag` (merged to dev)

### Service Scripts: DB_NAME Support

**Branch:** `feature/service-dynamic-db-name` (merged to dev)

**Files changed:**
- `build/data-alchemy-service-prod-dataset.sh`
- `build/data-alchemy-service-staging-dataset.sh`

**Usage in systemd:**
```ini
Environment="DB_NAME={vendor}-{ds}-backfill"
```

### Equities Grabber Map Verification

Verified all 102 production files are covered:

| Pattern Type | Extensions | Covered |
|--------------|------------|---------|
| CamelCase equity | .csv, .parquet | Yes |
| Underscore equity_ | .out, .dif, .px, .rpx, .px.hpc | Yes |

**Regions:** Asia1, Asia2, Euro, Lamr, Namr, MifidEuro

### Currency Mapping Analysis

Verified naming patterns:
- `.csv`, `.parquet` → CamelCase (`curncyAsia1.csv`)
- `.out` → underscore (`curncy_asia1.out`)

Decrypt pattern `curncy_.*\.out\.gz\.enc` is correct (lowercase).

---

## Commands Reference

```bash
# Test futures 2.0 mapping
source .env && uv run python -m data_alchemy.main \
  --vendor bloomberg \
  --dataset bbocax_cwiq_pipe \
  --version 1.0 \
  --test-limit 10 \
  --backfill 5000 \
  --ignore-db \
  --db-name "{vendor}-{ds}-testbackfill" \
  --file-pattern ".*FuturesBulk.*"

# Check sqlite database
sqlite3 /path/to/db.sqlite "SELECT stratum, COUNT(*) FROM filemetadata GROUP BY stratum;"
```

---

## Tasks

- [ ] Create futures_extended grabber maps (1.0, 2.0, 3.0)

---
