# Session: 2026-01-26 (Linux)

## Summary
Continued work on bbocax service split for multi-output datasets with db_name log context. Fixed FILE_PATTERN regex for all split services.

## Branches
- `feature/bbocax-split-services` - main split services work
- `fix/bbocax-file-patterns` - pattern corrections

## Final FILE_PATTERN for Split Services

### 1. back_office_futures
```
(share|nonShare)FuturesBulk
```
**Matches:**
- `shareFuturesBulkAsia1.dif`
- `shareFuturesBulkEuro.out`
- `nonShareFuturesBulkAsia.dif`
- `nonShareFuturesBulkNamr.out`

**Does NOT match (different dataset - back_office_futures_extended):**
- `shareFuturesExtendedAsia1.csv`
- `nonShareFuturesExtendedAsia.out`

### 2. corporate_actions
```
(equity_(asia1|asia2|euro|lamr|namr)\.cax|(equity|effDt).+CorporateActions)
```
**Matches:**
- `equity_asia1.cax`, `equity_asia2.cax`, `equity_euro.cax`, `equity_lamr.cax`, `equity_namr.cax`
- `equityAsia1CorporateActions.parquet`
- `effDtEquityAsia1CorporateActionsCorporateActions.parquet`
- `effDtPfdExchAsiaCorporateActionsCorporateActions.parquet`

**Does NOT match (different dataset - back_office_equities):**
- `equityAsia1.parquet`
- `equity_asia1.dif`
- `equityAsia1Pricing.parquet`

### 3. back_office_preferred_exch_corporate_actions
```
(pfdExch(Asia|Euro|Lamr|Namr)CorporateActions|pfd_exch_(asia|euro|lamr|namr)\.cax)
```
**Matches:**
- `pfdExchAsiaCorporateActions.parquet`
- `pfdExchEuroCorporateActions.parquet`
- `pfd_exch_asia.cax`
- `pfd_exch_euro.cax`

**Does NOT match (different dataset - back_office_preferred_exch):**
- `pfdExchAsia.parquet`
- `pfd_exch_asia.out`
- `pfd_exch_asia.dif`

## Dataset Separation Summary

| Platinum Dataset | Key File Types |
|-----------------|----------------|
| back_office_futures | `*FuturesBulk*.{out,dif}` |
| back_office_futures_extended | `*FuturesExtended*.{csv,out,parquet}` |
| corporate_actions | `equity_*.cax`, `*CorporateActions.parquet` |
| back_office_equities | `equity*.{csv,parquet,dif,out}` (no CorporateActions) |
| back_office_preferred_exch_corporate_actions | `pfd_exch_*.cax`, `pfdExch*CorporateActions.parquet` |
| back_office_preferred_exch | `pfdExch*.{csv,parquet,dif,out}` (no CorporateActions) |

## Service Files Created

### Staging (active)
- `data-alchemy-staging-bloomberg-1.0-bbocax-back_office_futures.service`
- `data-alchemy-staging-bloomberg-1.0-bbocax-corporate_actions.service`
- `data-alchemy-staging-bloomberg-1.0-bbocax-back_office_preferred_exch_corporate_actions.service`

### Prod (service files ready, commented in playbook)
- `data-alchemy-prod-bloomberg-1.0-bbocax-back_office_futures.service`
- `data-alchemy-prod-bloomberg-1.0-bbocax-corporate_actions.service`
- `data-alchemy-prod-bloomberg-1.0-bbocax-back_office_preferred_exch_corporate_actions.service`

## Key Learnings

1. **Systemd Environment Quoting**: FILE_PATTERN with special characters (|, (, ), .) must be quoted:
   ```
   Environment="FILE_PATTERN=(pattern)"
   ```

2. **Regex vs Glob**: FILE_PATTERN uses Python `re.search()`, so:
   - `*` = zero or more of previous char (regex)
   - `.*` = any characters (regex)
   - Pattern matches anywhere in filename (search, not match)

3. **Pattern Specificity**: Patterns must be specific to avoid matching files from other datasets:
   - `pfd_exch_` too broad - matches back_office_preferred_exch files
   - `pfd_exch_(asia|euro|lamr|namr)\.cax` specific to corporate_actions

## Future Enhancement Idea

Config-driven service management with enable/disable toggle:
```yaml
# config/staging_services.yaml
services:
  bbocax-back_office_futures:
    enabled: true
    vendor: bloomberg
    dataset: bbocax_cwiq_pipe
    version: "1.0"
    db_name: "{vendor}--{ds}--back_office_futures"
    file_pattern: "(share|nonShare)FuturesBulk"
```

## Commits
```
# fix/bbocax-file-patterns branch
dba9e38 fix: correct FILE_PATTERN for corporate_actions
5c3cc52 fix: correct FILE_PATTERN for back_office_preferred_exch_corporate_actions

# feature/bbocax-split-services branch
fa2912b fix: quote FILE_PATTERN regex in service files
ba400b8 docs: add commented bbocax split services to prod06 playbook
8aef7b2 refactor: replace bbocax_cwiq_pipe with split services in staging
ce198ff fix: correct FILE_PATTERN for back_office_preferred_exch_corporate_actions services
90b1b3a feat: add split service files for bbocax back_office_futures
a03d4f0 feat: add split service files for bbocax corporate actions
```

---

## Session 2 - Additional Split Services

### Branch: `feature/bbocax-additional-split-services`

Created remaining bbocax split service files (staging + prod).

### New Services Created

| Dataset | Pattern |
|---------|---------|
| back_office_equities | `(equity(Asia1\|Asia2\|Euro\|Lamr\|Namr\|MifidEuro)(?!.*(CorporateActions\|\.cax))\|equity_(asia1\|asia2\|euro\|lamr\|namr\|mifid_euro)(?!\.cax))` |
| back_office_preferred_exch | `(pfdExch(Asia\|Euro\|Lamr\|Namr)(?!.*(CorporateActions\|\.cax))\|pfd_exch_(asia\|euro\|lamr\|namr)(?!\.cax))` |
| back_office_futures_extended | `(share\|nonShare)FuturesExtended` |
| back_office_currency | `[Cc]urncy` |
| back_office_supplemental | `(condition_code\|fields\.\|lookup\.)` |

### Pattern Verification
Verified all patterns against `/sf/data/bloomberg/bbocax_cwiq_pipe/1.0/raw/env1/` source files.

### Key Pattern Techniques

1. **Negative lookahead for exclusion**:
   - `(?!.*(CorporateActions|\.cax))` - excludes if pattern exists anywhere after
   - `(?!\.cax)` - excludes if .cax immediately follows

2. **Pattern examples**:
   - `equityAsia1.csv` - matches (no CorporateActions or .cax)
   - `equityAsia1CorporateActions.parquet` - does NOT match
   - `equity_asia1.cax` - does NOT match
   - `equity_asia1.out` - matches

### Commits on feature/bbocax-additional-split-services
```
40155fd feat: add split service files for bbocax remaining datasets
6f34974 feat: add split service files for bbocax back_office_currency
0761ba1 fix: correct FILE_PATTERN for bbocax split services
```

### Complete Service File List (Staging + Prod)
- back_office_futures
- back_office_futures_extended
- back_office_equities
- back_office_preferred_exch
- back_office_currency
- back_office_supplemental
- corporate_actions
- back_office_preferred_exch_corporate_actions

## Next Steps
- Merge branches and test in staging
- When validated, enable in production
