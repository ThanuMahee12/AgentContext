# 2026-01-15

## Project: data-alchemy

**Repo:** alchmy (parent) + data-alchemy (submodule)

**Environment:** Linux machine

**Branch:** `feature/bbocax-futures` (data-alchemy submodule)

---

### Progress Today

**Session 1:**
- Pulled AgentContext updates (Windows session synced)
- Created Linux session file
- Verified `--file-pattern` CLI flag for filtering files (not `--pattern`)
- Confirmed raw cwiq_pipe file patterns for futures
- Created server-friendly command with `nice`, `nohup`, and `tee` for logging
- Ran DQ validation (20251110:20251120) - type mismatches found
- Fixed: Added `gzip_no_ext` compression to futures grabber map
- Pushed fix to `feature/bbocax-futures` (commit `6aa26f0`)

---

### bbocax-futures Real Server Testing

**Grabber map:** `bloomberg_bbocax_cwiq_pipe_futures_2_0.json`

**Raw files (cwiq_pipe/env0):**
- `shareFuturesBulk*.{out,dif}.gz.enc`
- `nonShareFuturesBulk*.{out,dif}.gz.enc`

**Command (basic):**
```bash
uv run python -m data_alchemy.main --vendor bloomberg --dataset bbocax_cwiq_pipe --version 1.0 --backfill 2000 --file-pattern "shareFuturesBulk|nonShareFuturesBulk"
```

**Command (server-friendly with tee):**
```bash
nice -n 10 nohup uv run python -m data_alchemy.main --vendor bloomberg --dataset bbocax_cwiq_pipe --version 1.0 --backfill 2000 --file-pattern "shareFuturesBulk|nonShareFuturesBulk" 2>&1 | tee /home/svc_dat_alche_u/workspace/thanudev/logs/bbocax-futures-$(date +%Y%m%d-%H%M%S).log &
```

**DQ validation command:**
```bash
nice -n 10 nohup uv run python -m data_alchemy.main --vendor bloomberg --dataset bbocax_cwiq_pipe --version 1.0 --dq --verbose-dq --dq-date-range 20251110:20251120 --file-pattern "shareFuturesBulk|nonShareFuturesBulk" 2>&1 | tee /home/svc_dat_alche_u/workspace/thanudev/logs/bbocax-futures-dq-$(date +%Y%m%d-%H%M%S).log &
```

**DQ Results (20251110:20251120) - Before Fix:**
- Dataset: `bloomberg/back_office_futures/2.0`
- Files Checked: 418
- Type mismatches: ~300 (all dates, all FuturesBulk files)
  - comparison: `application/gzip` (legacy shovel)
  - output: `text/plain` (data-alchemy - decompressed)

**Why type must match:**
- DQ validation checks MIME type for 100% shovel compatibility
- Legacy shovel outputs gzip files → `application/gzip`
- data-alchemy must output same type to pass DQ

**Fix Applied:**
- Added `"compression": "gzip_no_ext"` to `bloomberg_bbocax_cwiq_pipe_futures_2_0.json`
- `gzip_no_ext` = gzip content + keep original filename (no `.gz` extension)
- Result: output MIME type = `application/gzip` ✅
- Commit: `6aa26f0` on `feature/bbocax-futures`
- This matches existing bbocax pattern (`.cax` files use same compression)

**Compression Pattern (bbocax):**

| Grabber Map | Compression |
|-------------|-------------|
| `*_cax_*.json` | `gzip_no_ext` |
| `*_parquet_*.json` | `none` |
| `*_futures_2_0.json` | `gzip_no_ext` |
| `*_1_0.json` | `none` |

**Flow:**
```
raw/env0/shareFuturesBulkAsia1.dif.gz.enc.20251229
    ↓ (bronze → silver: decrypt + decompress)
silver/2025/12/29/work/053907-0500--shareFuturesBulkAsia1.dif
    ↓ (silver → gold: grabber map transformation)
back_office_futures/2.0/raw/share_futures/2025/20251229/shareFuturesBulkAsia1.dif
```

**Output locations:**
- `bloomberg/back_office_futures/2.0/raw/share_futures/{YYYY}/{YYYYMMDD}/`
- `bloomberg/back_office_futures/2.0/raw/non_share_futures/{YYYY}/{YYYYMMDD}/`

---

### Context from Yesterday

- Cycle duration analysis completed (179 cycles, mean 3.04 min)
- DQ validation **PASSED** (20 dates checked)
- 459 missing `.ndjson` files identified (intentional - not mapped)
- 56 `.cax` type mismatches (expected - gzip vs text/plain)

### Pending from Yesterday

- Review if `.ndjson` outputs should be added to grabber map
- Commit and push data-alchemy changes

---

### Next

- Run real server test with `--file-pattern`
- Verify output in `back_office_futures/2.0/raw/`

---
